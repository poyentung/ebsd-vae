# Benchmarking Scripts

Here contains scripts to benchmark the performance of different indexing methods for diffraction patterns.

## Prerequisites

Before running these scripts, ensure you have the following:

- **Pattern Data:** A NumPy file (`.npy`) containing the diffraction patterns (e.g., `patterns.npy`). This should be specified using the `--pattern_path` argument.
- **Angles Data:** A NumPy file (`.npy`) containing the corresponding orientation angles (e.g., `angles.npy`). This should be specified using the `--angles_path` argument.
- **VAE Model Checkpoint:** For scripts using the VAE (`benchmark_faiss_16d.py`, `benchmark_chromadb_16d.py`), a trained VAE model checkpoint file (e.g., `checkpoints/vae-best.pt`). This should be specified using the `--model_path` argument.
- **ChromaDB Artefacts:** For `benchmark_chromadb_16d.py` and `benchmark_chromadb_raw.py`, you must have the pre-built ChromaDB artefacts available to run these benchmarks.

> [!NOTE]
> To set up the `ChromaDB` artifacts, you have to download and unzip the files to the folder and specify their path upon benchmarking (using the argument `--persist_directory`):
> - [chroma_db_raw](https://drive.google.com/file/d/1OX-M71RMhO9QpzktPF4SAfIJKgLikMkv/view?usp=drive_link)
> - [chroma_db_16d](https://drive.google.com/file/d/1L7JurUBwHYVwl7DZHggkvqyuMrN-43lI/view?usp=drive_link)

## Usage

Navigate to the root directory of the `latice` project before running these commands.

### 1. Faiss Indexing (16D Latent Space)

This script benchmarks indexing speed using a Faiss index built on the 16-dimensional latent space generated by the VAE.

```bash
python -m latice.script.benchmark_faiss_16d --pattern_path <path/to/patterns.npy> --angles_path <path/to/angles.npy> --model_path <path/to/vae-best.pt> [OPTIONS]
```

**Key Options:**

- `--npz_path`: Path to the Faiss index file (default: `faiss_index.npz`).
- `--dimension`: Latent dimension (default: 16).
- `--device`: Device (`cpu`, `mps` or `cuda`) (default: `cpu`).
- `--n_samples`: Number of patterns to sample for timing (default: 1000).
- `--output_path`: Path to save the timing results CSV (default: `benchmark_faiss_16d.csv`).

### 2. ChromaDB Indexing (Raw Patterns)

This script benchmarks indexing speed using ChromaDB directly on the raw diffraction patterns.

```bash
python -m latice.script.benchmark_chromadb_raw --pattern_path <path/to/patterns.npy> --angles_path <path/to/angles.txt> [OPTIONS]
```

**Key Options:**

- `--image_size`: Dimensions of the input patterns (default: `(128, 128)`).
- `--n_samples`: Number of patterns to sample for timing (default: 1000).
- `--persist_directory`: Directory for ChromaDB persistence (default: `notebook/.chroma_db_raw`).
- `--output_path`: Path to save the timing results CSV (default: `benchmark_chromadb_raw.csv`).

### 3. ChromaDB Indexing (16D Latent Space)

This script benchmarks indexing speed using ChromaDB on the 16-dimensional latent space generated by the VAE.

```bash
python -m latice.script.benchmark_chromadb_16d --pattern_path <path/to/patterns.npy> --angles_path <path/to/angles.txt> --model_path <path/to/vae-best.pt> [OPTIONS]
```

**Key Options:**

- `--dimension`: Latent dimension (default: 16).
- `--device`: Device (`cpu`, `mps` or `cuda`) (default: `cpu`).
- `--n_samples`: Number of patterns to sample for timing (default: 1000).
- `--persist_directory`: Directory for ChromaDB persistence (default: `notebook/.chroma_db_16d`).
- `--output_path`: Path to save the timing results CSV (default: `benchmark_chromadb_16d.csv`).

## Example Commands

Here are example commands using specific data files:

```bash
# Faiss 16D with GPU
uv run python -m latice.script.benchmark_faiss_16d --pattern-path data/N=100_noised.npy --angles-path data/anglefile_N=100.txt --model-path checkpoints/vae-best.pt --output-path benchmark_faiss_16d.csv --device cuda 

# ChromaDB 16D with GPU
uv run python -m latice.script.benchmark_chromadb_16d --pattern-path data/N=100_noised.npy --angles-path data/anglefile_N=100.txt --model-path checkpoints/vae-best.pt --output-path benchmark_chromadb_16d.csv --persist-directory notebook/.chroma_db_16d --device cuda

# ChromaDB Raw
uv run python -m latice.script.benchmark_chromadb_raw --pattern-path data/N=100_noised.npy --angles-path data/anglefile_N=100.txt --output-path benchmark_chromadb_raw.csv --persist-directory notebook/.chroma_db_raw
```

## Output

Each script will generate a CSV file containing the time taken for indexing each sampled pattern. It will also print the mean and standard deviation of the indexing times to the console. 